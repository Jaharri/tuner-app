<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromatic Guitar Tuner</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #tuningStatus { font-size: 24px; font-weight: bold; }
        select, button { font-size: 18px; margin: 10px; padding: 10px; }
    </style>
</head>
<body>

    <h1>Chromatic Guitar Tuner</h1>
    <button onclick="startTuner()">Start Tuning</button>

    <p id="frequency">Frequency: -- Hz</p>
    <p id="note">Note: --</p>
    <p id="tuningStatus">Waiting for input...</p>

    <script>
        let lastFrequencies = [];

        async function startTuner() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Your browser does not support microphone access.");
                return;
            }

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            analyser.fftSize = 2048;
            microphone.connect(analyser);
            
            const buffer = new Float32Array(analyser.fftSize);
            function detectPitch() {
                analyser.getFloatTimeDomainData(buffer);
                let frequency = getPitch(buffer, audioContext.sampleRate);

                if (frequency > 50 && frequency < 1000) { 
                    frequency = smoothFrequency(frequency);
                    document.getElementById("frequency").innerText = `Frequency: ${frequency.toFixed(2)} Hz`;
                    updateTuningStatus(frequency);
                }
                requestAnimationFrame(detectPitch);
            }
            detectPitch();
        }

        function getPitch(buffer, sampleRate) {
            let size = buffer.length;
            let rms = 0;
            for (let i = 0; i < size; i++) {
                rms += buffer[i] * buffer[i];
            }
            rms = Math.sqrt(rms / size);
            if (rms < 0.01) return -1;

            let bestOffset = -1, bestCorrelation = 0;
            for (let offset = 50; offset < size / 2; offset++) {
                let correlation = 0;
                for (let i = 0; i < size / 2; i++) {
                    correlation += buffer[i] * buffer[i + offset];
                }
                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
            }
            return bestOffset > 0 ? sampleRate / bestOffset : -1;
        }

        function smoothFrequency(freq) {
            lastFrequencies.push(freq);
            if (lastFrequencies.length > 5) lastFrequencies.shift();
            return lastFrequencies.reduce((a, b) => a + b, 0) / lastFrequencies.length;
        }

        const noteFrequencies = [
            { note: "C", freq: 16.35 }, { note: "C#", freq: 17.32 }, { note: "D", freq: 18.35 }, { note: "D#", freq: 19.45 },
            { note: "E", freq: 20.60 }, { note: "F", freq: 21.83 }, { note: "F#", freq: 23.12 }, { note: "G", freq: 24.50 },
            { note: "G#", freq: 25.96 }, { note: "A", freq: 27.50 }, { note: "A#", freq: 29.14 }, { note: "B", freq: 30.87 }
        ];

        function getClosestNote(frequency) {
            let minDiff = Infinity;
            let closestNote = "";
            let targetFreq = 0;

            for (let i = 0; i < 100; i++) {
                let octave = Math.floor(i / 12);
                let baseNote = noteFrequencies[i % 12];
                let noteFreq = baseNote.freq * Math.pow(2, octave);
                
                let diff = Math.abs(frequency - noteFreq);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestNote = baseNote.note + (octave + 1);
                    targetFreq = noteFreq;
                }
            }
            return { note: closestNote, frequency: targetFreq };
        }

        function updateTuningStatus(frequency) {
            const { note, frequency: targetFreq } = getClosestNote(frequency);
            document.getElementById("note").innerText = `Note: ${note}`;

            const diff = frequency - targetFreq;
            const tolerance = 2;

            let statusText = "";
            let statusColor = "black";

            if (Math.abs(diff) <= tolerance) {
                statusText = "✅ In Tune!";
                statusColor = "green";
            } else if (diff > 0) {
                statusText = "⬇️ Tune Down";
                statusColor = "red";
            } else {
                statusText = "⬆️ Tune Up";
                statusColor = "red";
            }

            document.getElementById("tuningStatus").innerText = statusText;
            document.getElementById("tuningStatus").style.color = statusColor;
        }
    </script>

</body>
</html>
