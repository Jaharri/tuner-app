<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromatic Guitar Tuner</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        #slider-container { position: relative; width: 300px; margin: 20px auto; }
        #tune-slider { width: 100%; }
        #indicator { position: absolute; width: 10px; height: 20px; background: red; top: 5px; left: 50%; transform: translateX(-50%); }
    </style>
</head>
<body>
    <h1>Chromatic Guitar Tuner</h1>
    <p>Select a note to tune to:</p>
    <select id="note-selector">
        <option value="82.41">E2 (Low E)</option>
        <option value="110.00">A2</option>
        <option value="146.83">D3</option>
        <option value="196.00">G3</option>
        <option value="246.94">B3</option>
        <option value="329.63">E4 (High E)</option>
        <option value="Any">Chromatic</option>
    </select>

    <div id="slider-container">
        <input type="range" id="tune-slider" min="-50" max="50" value="0" disabled>
        <div id="indicator"></div>
    </div>
    <p id="status">Waiting for input...</p>

    <script>
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let analyser = audioContext.createAnalyser();
        let dataArray = new Float32Array(analyser.fftSize);
        let selectedFrequency = 82.41; // Default to low E

        document.getElementById('note-selector').addEventListener('change', function () {
            let value = this.value;
            selectedFrequency = value === "Any" ? null : parseFloat(value);
        });

        async function startTuner() {
            let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            let source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);

            function detectPitch() {
                analyser.getFloatTimeDomainData(dataArray);
                let frequency = autoCorrelate(dataArray, audioContext.sampleRate);
                if (frequency > 0) {
                    updateUI(frequency);
                }
                requestAnimationFrame(detectPitch);
            }
            detectPitch();
        }

        function updateUI(frequency) {
            let status = document.getElementById('status');
            let slider = document.getElementById('tune-slider');
            let indicator = document.getElementById('indicator');

            let targetFrequency = selectedFrequency;
            if (!targetFrequency) {
                targetFrequency = findClosestNoteFrequency(frequency);
            }

            let diff = frequency - targetFrequency;
            let offset = Math.max(-50, Math.min(50, (diff / targetFrequency) * 200)); // Normalize range

            slider.value = offset;
            indicator.style.left = `${50 + offset}%`;

            if (Math.abs(diff) < 2) {
                status.textContent = `In tune: ${frequency.toFixed(2)} Hz`;
                status.style.color = "green";
            } else if (diff > 0) {
                status.textContent = `Too sharp (${frequency.toFixed(2)} Hz)`;
                status.style.color = "red";
            } else {
                status.textContent = `Too flat (${frequency.toFixed(2)} Hz)`;
                status.style.color = "blue";
            }
        }

        function autoCorrelate(buffer, sampleRate) {
            let SIZE = buffer.length;
            let bestOffset = -1, bestCorrelation = 0, rms = 0;

            for (let i = 0; i < SIZE; i++) {
                let val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;

            let lastCorrelation = 1;
            for (let offset = 1; offset < SIZE / 2; offset++) {
                let correlation = 0;
                for (let i = 0; i < SIZE / 2; i++) {
                    correlation += buffer[i] * buffer[i + offset];
                }
                correlation = correlation / (rms * SIZE);
                if (correlation > 0.9 && correlation > lastCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
                lastCorrelation = correlation;
            }

            if (bestCorrelation > 0.9) {
                return sampleRate / bestOffset;
            }
            return -1;
        }

        function findClosestNoteFrequency(frequency) {
            let notes = [82.41, 87.31, 92.50, 98.00, 103.83, 110.00, 116.54, 123.47, 130.81, 138.59, 146.83, 155.56,
                         164.81, 174.61, 185.00, 196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66, 311.13,
                         329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88];
            return notes.reduce((prev, curr) => Math.abs(curr - frequency) < Math.abs(prev - frequency) ? curr : prev);
        }

        startTuner();
    </script>
</body>
</html>
