<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromatic Guitar Tuner</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #tuningStatus { font-size: 24px; font-weight: bold; }
        select, button { font-size: 18px; margin: 10px; padding: 10px; }
    </style>
</head>
<body>

    <h1>Chromatic Guitar Tuner</h1>
    <p>Select a note to tune:</p>
    
    <select id="noteSelect">
        <option value="E2">E (Low) - 82.41 Hz</option>
        <option value="A2">A - 110.00 Hz</option>
        <option value="D3">D - 146.83 Hz</option>
        <option value="G3">G - 196.00 Hz</option>
        <option value="B3">B - 246.94 Hz</option>
        <option value="E4">E (High) - 329.63 Hz</option>
    </select>

    <button onclick="startTuner()">Start Tuning</button>
    
    <p id="frequency">Frequency: -- Hz</p>
    <p id="tuningStatus">Select a note to tune.</p>

    <script>
        let lastFrequencies = [];

        async function startTuner() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Your browser does not support microphone access.");
                return;
            }

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            analyser.fftSize = 2048;
            microphone.connect(analyser);
            
            const buffer = new Float32Array(analyser.fftSize);
            function detectPitch() {
                analyser.getFloatTimeDomainData(buffer);
                let frequency = getPitch(buffer, audioContext.sampleRate);

                if (frequency > 50 && frequency < 1000) { 
                    frequency = smoothFrequency(frequency);
                    document.getElementById("frequency").innerText = `Frequency: ${frequency.toFixed(2)} Hz`;
                    updateTuningStatus(frequency);
                }
                requestAnimationFrame(detectPitch);
            }
            detectPitch();
        }

        function getPitch(buffer, sampleRate) {
            let size = buffer.length;
            let rms = 0;
            for (let i = 0; i < size; i++) {
                rms += buffer[i] * buffer[i];
            }
            rms = Math.sqrt(rms / size);
            if (rms < 0.01) return -1;

            let bestOffset = -1, bestCorrelation = 0;
            for (let offset = 50; offset < size / 2; offset++) {
                let correlation = 0;
                for (let i = 0; i < size / 2; i++) {
                    correlation += buffer[i] * buffer[i + offset];
                }
                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
            }
            return bestOffset > 0 ? sampleRate / bestOffset : -1;
        }

        function smoothFrequency(freq) {
            lastFrequencies.push(freq);
            if (lastFrequencies.length > 5) lastFrequencies.shift();
            return lastFrequencies.reduce((a, b) => a + b, 0) / lastFrequencies.length;
        }

        const notes = {
            "E2": 82.41, "A2": 110.00, "D3": 146.83, "G3": 196.00, "B3": 246.94, "E4": 329.63
        };

        function updateTuningStatus(frequency) {
            const selectedNote = document.getElementById("noteSelect").value;
            const targetFreq = notes[selectedNote];
            const diff = frequency - targetFreq;
            const tolerance = 2;

            let statusText = "";
            let statusColor = "black";

            if (Math.abs(diff) <= tolerance) {
                statusText = "✅ In Tune!";
                statusColor = "green";
            } else if (diff > 0) {
                statusText = "⬇️ Tune Down";
                statusColor = "red";
            } else {
                statusText = "⬆️ Tune Up";
                statusColor = "red";
            }

            document.getElementById("tuningStatus").innerText = statusText;
            document.getElementById("tuningStatus").style.color = statusColor;
        }
    </script>

</body>
</html>
