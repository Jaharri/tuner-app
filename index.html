<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromatic Guitar Tuner</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        .note-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 20px; }
        button { font-size: 18px; padding: 10px; cursor: pointer; }
        #tuningMeter { width: 100%; height: 20px; background: lightgray; position: relative; margin-top: 20px; }
        #indicator { width: 10px; height: 20px; background: red; position: absolute; left: 50%; transform: translateX(-50%); }
    </style>
</head>
<body>

    <h1>Chromatic Guitar Tuner</h1>
    <div class="note-buttons">
        <button onclick="setTargetNote('C')">C</button>
        <button onclick="setTargetNote('C#')">C#</button>
        <button onclick="setTargetNote('D')">D</button>
        <button onclick="setTargetNote('D#')">D#</button>
        <button onclick="setTargetNote('E')">E</button>
        <button onclick="setTargetNote('F')">F</button>
        <button onclick="setTargetNote('F#')">F#</button>
        <button onclick="setTargetNote('G')">G</button>
        <button onclick="setTargetNote('G#')">G#</button>
        <button onclick="setTargetNote('A')">A</button>
        <button onclick="setTargetNote('A#')">A#</button>
        <button onclick="setTargetNote('B')">B</button>
    </div>

    <button onclick="startTuner()">Start Tuning</button>

    <p id="selectedNote">Selected Note: --</p>
    <p id="frequency">Frequency: -- Hz</p>
    <div id="tuningMeter"><div id="indicator"></div></div>

    <script>
        let targetNote = null;
        const noteFrequencies = {
            "C": 130.81, "C#": 138.59, "D": 146.83, "D#": 155.56, "E": 164.81, "F": 174.61,
            "F#": 185.00, "G": 196.00, "G#": 207.65, "A": 220.00, "A#": 233.08, "B": 246.94
        };

        function setTargetNote(note) {
            targetNote = note;
            document.getElementById("selectedNote").innerText = `Selected Note: ${note}`;
        }

        async function startTuner() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Your browser does not support microphone access.");
                return;
            }

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            analyser.fftSize = 4096;
            microphone.connect(analyser);
            
            const buffer = new Float32Array(analyser.fftSize);
            function detectPitch() {
                analyser.getFloatTimeDomainData(buffer);
                let frequency = getPitch(buffer, audioContext.sampleRate);

                if (frequency > 50 && frequency < 1000) { 
                    document.getElementById("frequency").innerText = `Frequency: ${frequency.toFixed(2)} Hz`;
                    if (targetNote) updateTuningDisplay(frequency);
                }
                requestAnimationFrame(detectPitch);
            }
            detectPitch();
        }

        function getPitch(buffer, sampleRate) {
            let size = buffer.length;
            let bestOffset = -1, bestCorrelation = 0;
            for (let offset = 50; offset < size / 2; offset++) {
                let correlation = 0;
                for (let i = 0; i < size / 2; i++) {
                    correlation += buffer[i] * buffer[i + offset];
                }
                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
            }
            return bestOffset > 0 ? sampleRate / bestOffset : -1;
        }

        function updateTuningDisplay(frequency) {
            if (!targetNote) return;

            let baseFreq = noteFrequencies[targetNote];
            while (baseFreq * 2 <= 700) baseFreq *= 2; // Match closest octave for guitar tuning

            let diff = frequency - baseFreq;
            let percent = Math.min(50, Math.max(-50, (diff / baseFreq) * 100));

            let indicator = document.getElementById("indicator");
            indicator.style.left = `${50 + percent}%`;

            indicator.style.background = Math.abs(diff) < 2 ? "green" : "red";
        }
    </script>

</body>
</html>
